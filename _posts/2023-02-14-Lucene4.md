---
author_profile: true
date: 2023-02-14
title: "Apache Lucene 4 (Search Engine)"
categories: 
    - Search
tag: 
    - Lucene
    - SpringBoot
    - RestAPI

# 목차
toc: true  
toc_sticky: true 
# sidebar:
#  nav: "docs"
---

# Apache Lucene 3 (Lucene Document, Field Class)

---

## 1. Document, Field 차이

- Document : 색인과 검색 과정에 사용되는 기본 단위로, 하나 이상의 필드로 구성된다. RDB에 비교하면 테이블의 행(ROW) 와 같은 의미
- Field : 도큐먼트의 구성요서로 RDB와 비교하면 Column이라고 할 수 있다.

## 2. Document Class

Document는 색인 생성과 검색의 `기본단위` 로 사용자가 찾고자 하는 내용이 들어가 있다. 
텍스트 변환 과정에서 파싱된 원본 Document는 모두 루씬이 인식 할 수있게 변환된다.
Document는 담을 수 있는 데이터의 규모가 정해져 있지 않아 Doc 안에 Doc을 넣는 등 다양하게 활용이 가능하나 성능적 측면에서 이슈가 있을 수 있어 설계를 주의해서 해야 한다.

- Document 주요 클래스
  - add(IndexableField field) : 도큐먼트에 필드를 추가 한다. 같은 이름 필드 여러개를 추가 할 수 있다.
  - get(String name) : 도큐먼트의 필드 값을 String 타입으로 가져온다.
  - getField(String name) : 도큐먼트의 필드를 가져온다.
  - removeField(String name) : 도큐먼트에서 필드를 제거한다.

- 사용 예시
    ```java
    Document doc = new Document();

    doc.add(new StringField("id", userInfo.getId(), Field.Store.YES));
    doc.add(new TextField("info", userInfo.getInfo(), Field.Store.YES));
    doc.add(new StoredField("age", Integer.parseInt(userInfo.getAge())));
    Date modifiedDate = new Date();
    doc.add(new StringField("time", DateTools.dateToString(modifiedDate, DateTools.Resolution.DAY), Field.Store.YES));

    try {
        writer.addDocument(doc);
    } catch (Exception e) {
        e.printStackTrace();
    }
    ```

- Field.Store.YES , NO
  - 루씬에서 색인된 텍스트의 도큐먼트 전체 복사본을 저장할지 말지에 대한 여부 값을 정하는 것으로 `YES` 로 지정하면 필드의 전체 텍스트가 저장되고 검색 결과에 함께 반영된다.
  - 하지만, `NO` 로 지정 할 경우 도큐먼트가 색인 과정을 거쳐 검색대상이 되긴 하지만 검색 결과에 반영할 수는 없다.

- Document 삭제
  - 루씬 2, 3 버전에서는 IndexReader 클래스에서 도큐먼트를 삭제 했으나 의미가 맞지 않아 이후 버전 부터 IndexWriter의 deleteDocument()가 도큐먼트의 삭제를 맡는다.
  - 주의 사항으로는 deleteDocument()를 호출해도 바로 반영되는 것이 아닌 flush()가 수행될 때 실 색인에서 Document가 삭제된다.
  - deleteDocument() 로 도큐먼트를 삭제할 때는 검색된 모든 도큐먼트를 삭제하기 때문에 검색식 생성에 유의해야 한다.

    ```java
    try (IndexWriter w = new IndexWriter(index, config)){
      System.out.println("Before Delete Document Cnt : " + w.numDocs());
      // 수정할 대상을 검색하는 검색 식 쿼리 생성
      Query qry = new QueryParser("id", analyzer).parse(userId);
      w.deleteDocument(qry);
      System.out.println("Before Flush Document Cnt : " + w.numDocs());
      w.flush();
      System.out.println("After Flush Document Cnt : " + w.numDocs());
      w.close();
    }
    ```

- Document 수정
  - 루씬 2, 3 버전에서는 Update를 따로 지원하지 않아 delete()후 add() 하는 방식으로 진행 했지만, 이후 버전 부터는 IndexWirter의 updateDocument() 클래스를 통해 Document를 업데이트 할 수 있다.
  - updateDocument()로 수정할 도큐먼트를 찾고(검색) 삭제한 후 추가하는 식으로 업데이트가 진행된다. 사실상 수정보다는 교체
  - 따라서 Flush 이전에는 도큐먼트가 하나 늘어나나 flush 후에는 수정 대상 도큐먼트를 지우기 때문에 기존과 동일 해 짐.

    ```java
    try (IndexWriter w = new IndexWriter(index, config)){
      System.out.println("Before Delete Document Cnt : " + w.numDocs());
      // 수정할 도큐먼트를 설정한다.
      Term updateDocumentReview = new Term("id", id);
      // 수정할 도큐먼트를 매개변수로 받은 도큐먼트로 교체한다.
      w.updateDocument(updateDocumentReview, document);
      System.out.println("Before Flush Document Cnt : " + w.numDocs());
      w.flush();
      System.out.println("After Flush Document Cnt : " + w.numDocs());
      w.close();
    }
    ```

## 3. Field Class

필드는 도큐먼트의 일부분이다.
색인 하위에 도큐먼트가 있고, 도큐먼트는 여러 필드로 이뤄지고 각 필드의 값에는 텀이 포함된다.

![필드의 구조](/assets/images/2023-02-14/lucene1.png){: .align-center}

루씬의 도큐먼트는 다양한 타입의 필드를 색인한다.
Filed는 IndexableField 인터페이스의 구현체이다.

- Field의 서브 클래스
  - Stored Field
    - 색인에 필드 값을 저장하기 위한 필드 클래스
    - TextFeild : 전체 텍스트를 검색하는데 사용하는 필드로 자바의 String 타입
    - StringField : TextField와 마찬가지로 String 타입의 필드로 원본 데이터에서 토큰을 색인하는데 사용한다.
    - StoredFiled : 요약결과를 보관하는 필드로, 값만 저장한다.
  - RangeFiled
    - 범위 검색 쿼리를 위한 필드 클래스로, 검색 결과를 필터링 시 사용한다.
    - 예를 들어 숫자에 StoredField를 사용하면 범위 검색 쿼리나 정렬을 사용할 수 없다. 
    - 범위 검색과 정렬 모두 필요하면 색인 시 같은 이름의 StroedField와 기타 다른 필드를 같이 사용해야 한다.
    - IntPoint : 범위 쿼리를 위한 필드 클래스로 Int 타입 색인
    - LoingPoint : 범위 쿼리를 위한 필드 클래스로 long 타입 색인
    - FloatPoint : 범위 쿼리를 위한 필드 클래스로 float 타입 색인
    - DoublePoint : 범위 쿼리를 위한 필드 클래스로 double 타입 색인.
  - DocValue(정렬, 분류를 위한 집계성 클래스)
    - SortedDocValuesField : 정렬과 분류를 위해 byte[] 배열로 색인한다.
    - SotredSetDocValuesField : 정렬과 분류를 위해 `SortedSet<byte[]>` 으로 색인한다.
    - NumericDocVlauesField : 정렬과 분류를 위해 long으로 색인한다.
    - SortedNumericDocValuesField : 정렬과 분류를 위해 SortedSet으로 색인한다.

- Field 의 메소드
  - Field(String name, byte[] values, IndexableFiledType type) : 바이너리로 필드를 생성하는 생성자.
  - Field(String name, Reader reader, IndexableFieldType type) : Reader로 필드를 생성하는 생성자.
  - Field(String name, String value, IndexableFieldType type) : String으로 필드를 생성하는 생성자.
  - 